name: e2e Accounts - main TNR

on:
  workflow_dispatch:
  schedule:
    - cron: "0 6 * * 1-5" 

permissions:
  actions: write
  contents: read

concurrency:
  group: mytun-e2e-accounts
  cancel-in-progress: false

jobs:
  orchestrate:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger + wait Upgrade
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          REF: ${{ github.ref_name }}
          WF: e2e-accounts-tests-Upgrade.yml
        run: |
          set -euo pipefail

          start_ts="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          gh api -X POST "repos/$REPO/actions/workflows/$WF/dispatches" -f ref="$REF"

          run_id=""
          for i in $(seq 1 60); do
            run_id="$(gh api "repos/$REPO/actions/workflows/$WF/runs?event=workflow_dispatch&per_page=10" \
              --jq --arg START "$start_ts" --arg REF "$REF" '
                [.workflow_runs[]
                  | select(.head_branch == $REF)
                  | select(.created_at >= $START)
                ][0].id // empty
              ')"
            [ -n "$run_id" ] && break
            sleep 5
          done
          [ -n "$run_id" ] || (echo "ERROR: run introuvable pour $WF" && exit 1)

          while true; do
            status="$(gh api "repos/$REPO/actions/runs/$run_id" --jq '.status')"
            conclusion="$(gh api "repos/$REPO/actions/runs/$run_id" --jq '.conclusion // empty')"
            echo "Upgrade: status=$status conclusion=$conclusion"
            if [ "$status" = "completed" ]; then
              [ "$conclusion" = "success" ] || (echo "ERROR: Upgrade conclusion=$conclusion" && exit 1)
              break
            fi
            sleep 15
          done

      - name: Trigger + wait V7
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          REF: ${{ github.ref_name }}
          WF: e2e-accounts-V7-tnrs.yml
        run: |
          set -euo pipefail

          start_ts="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          gh api -X POST "repos/$REPO/actions/workflows/$WF/dispatches" -f ref="$REF"

          run_id=""
          for i in $(seq 1 60); do
            run_id="$(gh api "repos/$REPO/actions/workflows/$WF/runs?event=workflow_dispatch&per_page=10" \
              --jq --arg START "$start_ts" --arg REF "$REF" '
                [.workflow_runs[]
                  | select(.head_branch == $REF)
                  | select(.created_at >= $START)
                ][0].id // empty
              ')"
            [ -n "$run_id" ] && break
            sleep 5
          done
          [ -n "$run_id" ] || (echo "ERROR: run introuvable pour $WF" && exit 1)

          while true; do
            status="$(gh api "repos/$REPO/actions/runs/$run_id" --jq '.status')"
            conclusion="$(gh api "repos/$REPO/actions/runs/$run_id" --jq '.conclusion // empty')"
            echo "V7: status=$status conclusion=$conclusion"
            if [ "$status" = "completed" ]; then
              [ "$conclusion" = "success" ] || (echo "ERROR: V7 conclusion=$conclusion" && exit 1)
              break
            fi
            sleep 15
          done

      - name: Trigger + wait V8
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          REF: ${{ github.ref_name }}
          WF: e2e-accounts-V8-tnrs.yml
        run: |
          set -euo pipefail

          start_ts="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          gh api -X POST "repos/$REPO/actions/workflows/$WF/dispatches" -f ref="$REF"

          run_id=""
          for i in $(seq 1 60); do
            run_id="$(gh api "repos/$REPO/actions/workflows/$WF/runs?event=workflow_dispatch&per_page=10" \
              --jq --arg START "$start_ts" --arg REF "$REF" '
                [.workflow_runs[]
                  | select(.head_branch == $REF)
                  | select(.created_at >= $START)
                ][0].id // empty
              ')"
            [ -n "$run_id" ] && break
            sleep 5
          done
          [ -n "$run_id" ] || (echo "ERROR: run introuvable pour $WF" && exit 1)

          while true; do
            status="$(gh api "repos/$REPO/actions/runs/$run_id" --jq '.status')"
            conclusion="$(gh api "repos/$REPO/actions/runs/$run_id" --jq '.conclusion // empty')"
            echo "V8: status=$status conclusion=$conclusion"
            if [ "$status" = "completed" ]; then
              [ "$conclusion" = "success" ] || (echo "ERROR: V8 conclusion=$conclusion" && exit 1)
              break
            fi
            sleep 15
          done
