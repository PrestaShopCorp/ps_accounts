services:
  mysql:
    restart: unless-stopped
    image: ${IMAGE_PREFIX:-}mariadb:latest
    environment:
      TZ: Europe/Paris
      MYSQL_HOST: mysql
      MYSQL_USER: prestashop
      MYSQL_PASSWORD: prestashop
      MYSQL_ROOT_PASSWORD: prestashop
      MYSQL_PORT: 3306
      MYSQL_DATABASE: prestashop
    ports:
      - "3307:3306"
    profiles:
      - all
      - multistore
      - flashlight
      - imageoff
    # networks:
    #   - ps_accounts_net

  prestashop:
    restart: unless-stopped
    image: ${IMAGE_PREFIX:-}prestashop/prestashop-flashlight:${PS_VERSION}
    env_file: .env
    environment:
      ADMIN_MAIL: "admin@prestashop.com"
      ADMIN_PASSWD: "prestashop"
      PS_DOMAIN: ${PS_DOMAIN}
      PS_ACCOUNTS_VERSION: ${PS_ACCOUNTS_VERSION}
      SSL_REDIRECT: true
      PS_PROTOCOL: https
    volumes:
      - ./scripts-flashlight/init-scripts:/tmp/init-scripts:ro
      - ./scripts-flashlight/post-scripts:/tmp/post-scripts:ro
      - ./modules:/modules
    labels:
      - traefik.enable=true
      - traefik.http.routers.flashlight.rule=Host(`${PS_DOMAIN}`)
      - traefik.http.routers.flashlight.entrypoints=web
      - traefik.http.routers.flashlight.middlewares=flashlight-https
      - traefik.http.routers.flashlight.service=flashlight-svc
      - traefik.http.services.flashlight-svc.loadbalancer.server.port=80
      - traefik.http.middlewares.flashlight-https.headers.customrequestheaders.X-Forwarded-Proto=https
      - traefik.http.middlewares.flashlight-https.headers.customrequestheaders.X-Forwarded-Port=443
    ports:
      - "8000:80"
    profiles:
      - all
      - flashlight
    # networks:
    #   - ps_accounts_net

  phpmyadmin:
    image: ${IMAGE_PREFIX:-}phpmyadmin:latest
    ports:
      - 3006:80
    environment:
      - PMA_HOST=mysql
      - PMA_PORT=3306
      - PMA_USER=prestashop
      - PMA_PASSWORD=prestashop
      - MYSQL_ROOT_PASSWORD=prestashop
    profiles:
      - all
      - multistore
      - flashlight
      - imageoff
    # networks:
    #   - ps_accounts_net

  mytun:
    restart: always
    image: ${IMAGE_PREFIX:-}cloudflare/cloudflared:latest
    command: tunnel --config /config.yml run
    volumes:
      - ./myTun/config/mytun-config.yml:/config.yml:ro
      - ./myTun/config/mytun-credentials.json:/credentials.json:ro
    profiles:
      - all
      - multistore
      - flashlight
      - imageoff
    # networks:
    #   - ps_accounts_net

  shop1:
    image: prestashop/prestashop:${PS_VERSION}
    container_name: shop1
    restart: unless-stopped
    user: root
    depends_on:
      - mytun
    environment:
      PS_ACCOUNTS_VERSION: ${PS_ACCOUNTS_VERSION}
      PS_DOMAIN: ${PS_DOMAIN}
      ADMIN_MAIL: "admin@prestashop.com"
      ADMIN_PASSWD: "prestashop"
      DB_SERVER: mysql
      DB_USER: prestashop
      DB_NAME: prestashop
      DB_PASSWD: prestashop
      DB_PORT: 3306
      # PHYSICAL_URI: "shop1"
      PS_TRUSTED_PROXIES: 0.0.0.0/0
      PS_ERASE_DB: 1
      PS_INSTALL_DB: 1
      PS_INSTALL_AUTO: 1
      PS_FOLDER_ADMIN: admin-dev
      PS_DEV_MODE: 0
      PS_ENABLE_SSL: 1
    ports:
      - "9000:80"
    volumes:
      - ./scripts-imageoff/pre-install-scripts:/tmp/pre-install-scripts
      - ./scripts-imageoff/post-install-scripts:/tmp/post-install-scripts
      - ./scripts-imageoff/install-ps_accounts.sh:/install-ps_accounts.sh
    labels:
      - traefik.enable=true
      - traefik.http.routers.shop1-root.rule=Host(`${PS_DOMAIN}`)
      - traefik.http.routers.shop1-root.entrypoints=web
      - traefik.http.routers.shop1-root.priority=1
      - traefik.http.routers.shop1-root.middlewares=shop1-https
      - traefik.http.routers.shop1-root.service=shop1-svc
      - traefik.http.routers.shop1.rule=Host(`${PS_DOMAIN}`) && PathPrefix(`/shop1`)
      - traefik.http.routers.shop1.entrypoints=web
      - traefik.http.routers.shop1.priority=100
      - traefik.http.routers.shop1.middlewares=shop1-https
      - traefik.http.routers.shop1.service=shop1-svc
      - traefik.http.services.shop1-svc.loadbalancer.server.port=80
      - traefik.http.middlewares.shop1-https.headers.customrequestheaders.X-Forwarded-Proto=https
      - traefik.http.middlewares.shop1-https.headers.customrequestheaders.X-Forwarded-Port=443
    command: >
      bash -lc '
        /tmp/docker_run.sh & pid=$!
        until curl -fsS http://127.0.0.1/ >/dev/null 2>&1; do sleep 1; done       
        bash /install-ps_accounts.sh
        wait $$pid
      '
    profiles:
      - all
      - multistore
      - imageoff
    # networks:
    #   - ps_accounts_net

  shop2:
    image: prestashop/prestashop:${SECONDE_PS_VERSION}
    container_name: shop2
    restart: unless-stopped
    user: root
    environment:
      PS_ACCOUNTS_VERSION: ${PS_ACCOUNTS_VERSION}
      PS_DOMAIN: ${PS_DOMAIN}
      ADMIN_MAIL: "admin@prestashop.com"
      ADMIN_PASSWD: "prestashop"
      DB_SERVER: mysql
      DB_USER: prestashop
      DB_NAME: prestashop2
      DB_PASSWD: prestashop
      DB_PORT: 3306
      # PHYSICAL_URI: "shop2"
      SSL_REDIRECT: "true"
      PS_TRUSTED_PROXIES: 0.0.0.0/0
      PS_ERASE_DB: 1
      PS_INSTALL_DB: 1
      PS_INSTALL_AUTO: 1
      PS_FOLDER_ADMIN: admin-dev
      PS_DEV_MODE: 0
      PS_ENABLE_SSL: 1
    ports:
      - "9001:80"
    volumes:
      - ./scripts-imageoff/pre-install-scripts:/tmp/pre-install-scripts
      - ./scripts-imageoff/post-install-scripts:/tmp/post-install-scripts
      - ./scripts-imageoff/install-ps_accounts.sh:/install-ps_accounts.sh
    labels:
      - traefik.enable=true
      - traefik.http.routers.shop2.rule=Host(`${PS_DOMAIN}`) && PathPrefix(`/shop2`)
      - traefik.http.routers.shop2.entrypoints=web
      - traefik.http.routers.shop2.priority=100
      - traefik.http.routers.shop2.middlewares=shop2-https
      - traefik.http.routers.shop2.service=shop2-svc
      - traefik.http.services.shop2-svc.loadbalancer.server.port=80
      - traefik.http.middlewares.shop2-https.headers.customrequestheaders.X-Forwarded-Proto=https
      - traefik.http.middlewares.shop2-https.headers.customrequestheaders.X-Forwarded-Port=443
    command: >
      bash -lc '
        /tmp/docker_run.sh & pid=$!
        until curl -fsS http://127.0.0.1/ >/dev/null 2>&1; do sleep 1; done       
        bash /install-ps_accounts.sh
        wait $$pid
      '
    profiles:
      - all
      - multistore
    # networks:
    #   - ps_accounts_net

  traefik:
    image: traefik:v3.1
    container_name: traefik_proxy
    restart: unless-stopped
    command:
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --entrypoints.web.address=:80
      - --api.insecure=true
    ports:
      - "80:80"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    profiles:
      - all
      - multistore
      - flashlight
      - imageoff
#     networks:
#       - ps_accounts_net
# networks:
#   ps_accounts_net:
#     external: true
