services:
  mysql:
    restart: unless-stopped
    image: mariadb:lts
    environment:
      TZ: Europe/Paris
      MYSQL_HOST: mysql
      MYSQL_USER: prestashop
      MYSQL_PASSWORD: prestashop
      MYSQL_ROOT_PASSWORD: prestashop
      MYSQL_PORT: 3306
      MYSQL_DATABASE: prestashop
    healthcheck:
      test:
        [
          "CMD",
          "healthcheck.sh",
          "--connect",
        ]
      interval: 5s
      timeout: 10s
      retries: 5
    ports:
      - "${DB_BIND_PORT}:3306"

  prestashop:
    restart: unless-stopped
    image: prestashop/prestashop-flashlight:${SHOP_VERSION}
    env_file: .env
    depends_on:
      mysql:
        condition: service_healthy
    environment:
      ADMIN_MAIL: "ervin.klicic@prestashop.com"
      ADMIN_PASSWD: "prestashop"
      PS_DOMAIN: ${PS_DOMAIN}
      SSL_REDIRECT: true
    volumes:
      - ./init-scripts:/tmp/init-scripts:ro
    ports:
      - "8888:80"
    
  phpmyadmin:
      image: phpmyadmin:latest
      depends_on:
        mysql:
          condition: service_healthy
      ports:
        - ${HOST_PORT_BIND_PHP_MY_ADMIN:?See e2e-env/.env.dist}:80
      environment:
        - PMA_HOST=mysql
        - PMA_PORT=3306
        - PMA_USER=prestashop
        - PMA_PASSWORD=prestashop
        - MYSQL_ROOT_PASSWORD=prestashop

  mytun-config:
    restart: 'no'
    extends:
      file: ./myTun/docker-compose.yml
      service: config-generator
    environment:
      ACCOUNT_TAG: ${ACCOUNT_TAG}
      TUNNEL_SECRET: ${TUNNEL_SECRET}
      TUNNEL_ID: ${TUNNEL_ID}
      PS_DOMAIN: ${PS_DOMAIN}

  mytun:
    restart: always
    image: cloudflare/cloudflared:latest
    command: tunnel --config /config.yml run
    depends_on:
      mytun-config:
        condition: service_completed_successfully
    volumes:
      - ./myTun/config/mytun-config.yml:/config.yml
      - ./myTun/config/mytun-credentials.json:/credentials.json

volumes:
  modules:
    driver: local
